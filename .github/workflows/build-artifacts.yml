name: build-artifacts
on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-artifacts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      BUILD_NAME: "rustify-app-${{ github.ref_name }}-linux-x64"
      DATABASE_URL: "sqlite:splitify.db"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@nightly

    - name: Add WASM target
      run: rustup target add wasm32-unknown-unknown

    - name: Install Node.js (for tailwind)
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Node.js dependencies
      run: npm install

    - name: Install SQLx CLI
      run: |
        cargo install sqlx-cli --no-default-features --features sqlite

    - name: Setup database for SQLx compile-time verification
      run: |
        sqlx database create
        sqlx migrate run

    - name: Cache cargo registry and target
      uses: actions/cache@v4
      with:
        path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Install cargo-leptos
      run: |
        curl --proto '=https' --tlsv1.3 -LsSf \
          https://github.com/leptos-rs/cargo-leptos/releases/latest/download/cargo-leptos-installer.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Build release with cargo-leptos
      run: |
        cargo leptos build --release

    - name: Bundle release
      shell: bash
      run: |
        mkdir -p "$BUILD_NAME"
        
        # Copy documentation
        cp README.md LICENSE "$BUILD_NAME/" || true
        
        # Copy server binary
        cp "target/release/rustify-app" "$BUILD_NAME/"
        chmod +x "$BUILD_NAME/rustify-app"
        
        # Copy site directory (WASM, JS, CSS, assets)
        cp -r target/site "$BUILD_NAME/"
        
        # Copy migrations for database setup
        cp -r migrations "$BUILD_NAME/"
        
        # Create a simple run script
        cat > "$BUILD_NAME/run.sh" << 'EOF'
        #!/bin/bash
        set -e
        
        # Set environment variables
        export LEPTOS_SITE_ROOT="./site"
        export DATABASE_URL="${DATABASE_URL:-sqlite:splitify.db}"
        export RUST_LOG="${RUST_LOG:-info}"
        export LEPTOS_SITE_ADDR="${LEPTOS_SITE_ADDR:-127.0.0.1:8080}"
        
        echo "Starting Rustify App..."
        echo "Site root: $LEPTOS_SITE_ROOT"
        echo "Database: $DATABASE_URL"
        echo "Listening on: $LEPTOS_SITE_ADDR"
        
        # Run the server
        ./rustify-app
        EOF
        
        chmod +x "$BUILD_NAME/run.sh"

    - name: Create tarball
      shell: bash
      run: |
        tar -czf "$BUILD_NAME.tar.gz" "$BUILD_NAME"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.BUILD_NAME }}
        path: ${{ env.BUILD_NAME }}.tar.gz
        if-no-files-found: error
