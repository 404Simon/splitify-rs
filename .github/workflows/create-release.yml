name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g. v0.2.0)'
        required: true
        type: string

jobs:
  validate-version:
    runs-on: ubuntu-latest
    steps:
      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format vX.Y.Z (e.g., v0.2.0)"
            exit 1
          fi
          echo "Version format is valid: ${{ inputs.version }}"

  bump-and-tag:
    needs: [validate-version]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Bump version in Cargo.toml
        run: |
          CLEAN_VERSION=$(echo "${{ inputs.version }}" | sed 's/^v//')
          echo "Updating version to $CLEAN_VERSION"
          cargo set-version "$CLEAN_VERSION"
          
      - name: Verify version was updated
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)
          EXPECTED_VERSION=$(echo "${{ inputs.version }}" | sed 's/^v//')
          
          if [ "$CARGO_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "Error: Version mismatch. Expected $EXPECTED_VERSION but got $CARGO_VERSION"
            exit 1
          fi
          
          echo "Version successfully updated to $CARGO_VERSION"

      - name: Commit and tag
        run: |
          CLEAN_VERSION=$(echo "${{ inputs.version }}" | sed 's/^v//')
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Cargo.toml Cargo.lock
          git commit -m "chore: release v$CLEAN_VERSION"
          
          git tag "${{ inputs.version }}"
          
          git push
          git push origin "${{ inputs.version }}"
          
          echo "## Version Bump Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ inputs.version }}" \
            --draft=false \
            --latest \
            --generate-notes \
            --title "Release ${{ inputs.version }}" \
            --notes "This release was automatically created by GitHub Actions.
          
          ## Installation
          
          ### Docker
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}:${{ inputs.version }}
          docker run -p 8080:8080 -v ./data:/app/data ghcr.io/${{ github.repository }}:${{ inputs.version }}
          \`\`\`
          
          ### Binary
          Download the appropriate binary for your platform from the assets below, extract it, and run:
          \`\`\`bash
          # Linux/macOS
          ./run.sh
          
          # Windows
          run.bat
          \`\`\`
          
          ## What's Changed
          See the full changelog below for all changes included in this release."
